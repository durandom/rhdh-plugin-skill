#!/usr/bin/env bash
#
# rhdh-plugin - CLI helper for RHDH plugin management
#
# Follows agentic CLI patterns:
#   - No-arg default shows status + next steps (not help)
#   - Dry-run by default, --force for destructive actions
#   - Non-interactive (all input via flags)
#   - Discovery through output
#
# Location discovery (in order):
#   1. Skill install root (../repo/ relative to this script)
#   2. User config (~/.config/rhdh-plugin-skill/config.json)
#   3. Environment variables (RHDH_OVERLAY_REPO, etc.)
#

set -euo pipefail

# Determine script and skill locations
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SKILL_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Config locations
USER_CONFIG_DIR="${HOME}/.config/rhdh-plugin-skill"
USER_CONFIG_FILE="${USER_CONFIG_DIR}/config.json"

# Color output (disable if not a terminal)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' BOLD='' NC=''
fi

# Output helpers
log_ok()    { echo -e "  ${GREEN}✓${NC} $1"; }
log_warn()  { echo -e "  ${YELLOW}⚠${NC} $1"; }
log_fail()  { echo -e "  ${RED}✗${NC} $1"; }
log_info()  { echo -e "  ${BLUE}→${NC} $1"; }
header()    { echo -e "\n${BOLD}$1${NC}"; }

print_next_steps() {
    echo -e "\n${BOLD}Next steps:${NC}"
    while [[ $# -gt 0 ]]; do
        local cmd="$1"
        local desc="$2"
        printf "  ${BLUE}%-35s${NC} %s\n" "$cmd" "$desc"
        shift 2
    done
}

# ============================================================================
# Location Discovery
# ============================================================================

# Find repo in well-known locations
find_repo() {
    local repo_name="$1"
    local env_var="$2"

    # 1. Environment variable override
    if [[ -n "${!env_var:-}" ]]; then
        if [[ -d "${!env_var}" ]]; then
            echo "${!env_var}"
            return 0
        fi
    fi

    # 2. User config file
    if [[ -f "$USER_CONFIG_FILE" ]]; then
        local config_path
        config_path=$(jq -r ".repos.${repo_name} // empty" "$USER_CONFIG_FILE" 2>/dev/null || true)
        if [[ -n "$config_path" && -d "$config_path" ]]; then
            echo "$config_path"
            return 0
        fi
    fi

    # 3. Skill install root (../repo/ relative to skill)
    local skill_repo_path="${SKILL_ROOT}/../repo/${repo_name}"
    if [[ -d "$skill_repo_path" ]]; then
        echo "$(cd "$skill_repo_path" && pwd)"
        return 0
    fi

    # 4. Parent's repo/ directory (if skill is deeper nested)
    local parent_repo_path="${SKILL_ROOT}/../../repo/${repo_name}"
    if [[ -d "$parent_repo_path" ]]; then
        echo "$(cd "$parent_repo_path" && pwd)"
        return 0
    fi

    return 1
}

# Get all repo paths
get_overlay_repo()  { find_repo "rhdh-plugin-export-overlays" "RHDH_OVERLAY_REPO"; }
get_local_repo()    { find_repo "rhdh-local" "RHDH_LOCAL_REPO"; }
get_factory_repo()  { find_repo "rhdh-dynamic-plugin-factory" "RHDH_FACTORY_REPO"; }

# ============================================================================
# Status Commands
# ============================================================================

show_status() {
    header "RHDH Plugin Environment"

    local overlay_repo local_repo factory_repo
    local has_issues=false

    # Check overlay repo
    if overlay_repo=$(get_overlay_repo); then
        local branch status_info
        branch=$(git -C "$overlay_repo" branch --show-current 2>/dev/null || echo "unknown")
        if [[ -n "$(git -C "$overlay_repo" status --porcelain 2>/dev/null)" ]]; then
            status_info="(${branch}, uncommitted changes)"
        else
            status_info="(${branch}, clean)"
        fi
        log_ok "overlay repo: ${overlay_repo} ${status_info}"
    else
        log_fail "overlay repo: not found"
        has_issues=true
    fi

    # Check rhdh-local
    if local_repo=$(get_local_repo); then
        # Check if running
        if command -v podman &>/dev/null && podman ps --format '{{.Names}}' 2>/dev/null | grep -q rhdh; then
            log_ok "rhdh-local: ${local_repo} (running)"
        else
            log_warn "rhdh-local: ${local_repo} (not running)"
        fi
    else
        log_fail "rhdh-local: not found"
        has_issues=true
    fi

    # Check factory (optional)
    if factory_repo=$(get_factory_repo); then
        log_ok "factory: ${factory_repo}"
    else
        log_info "factory: not configured (optional)"
    fi

    # Check tools
    header "Tools"

    if command -v gh &>/dev/null; then
        if gh auth status &>/dev/null 2>&1; then
            log_ok "gh CLI: authenticated"
        else
            log_warn "gh CLI: installed but not authenticated"
            has_issues=true
        fi
    else
        log_fail "gh CLI: not installed"
        has_issues=true
    fi

    if command -v podman &>/dev/null; then
        log_ok "podman: $(podman --version | head -1)"
    elif command -v docker &>/dev/null; then
        log_ok "docker: $(docker --version | head -1)"
    else
        log_warn "container runtime: not found (needed for rhdh-local)"
    fi

    if command -v jq &>/dev/null; then
        log_ok "jq: installed"
    else
        log_warn "jq: not installed (recommended)"
    fi

    # Next steps based on state
    if [[ "$has_issues" == "true" ]]; then
        print_next_steps \
            "rhdh-plugin doctor" "Diagnose issues" \
            "rhdh-plugin config init" "Configure repo locations" \
            "rhdh-plugin --help" "Show all commands"
    else
        print_next_steps \
            "rhdh-plugin workspace list" "List plugin workspaces" \
            "rhdh-plugin doctor" "Full environment check" \
            "rhdh-plugin --help" "Show all commands"
    fi
}

# ============================================================================
# Doctor Command
# ============================================================================

run_doctor() {
    header "Environment Check"

    local issues=()

    # Check repos
    if overlay_repo=$(get_overlay_repo); then
        log_ok "Overlay repo found: $overlay_repo"

        # Check it's a git repo
        if git -C "$overlay_repo" rev-parse --git-dir &>/dev/null; then
            log_ok "  Git repository valid"
        else
            log_fail "  Not a valid git repository"
            issues+=("Overlay repo is not a git repository")
        fi

        # Check remote
        if git -C "$overlay_repo" remote get-url origin &>/dev/null; then
            local remote
            remote=$(git -C "$overlay_repo" remote get-url origin)
            if [[ "$remote" == *"rhdh-plugin-export-overlays"* ]]; then
                log_ok "  Remote: $remote"
            else
                log_warn "  Remote may be incorrect: $remote"
            fi
        fi
    else
        log_fail "Overlay repo not found"
        issues+=("Configure overlay repo: rhdh-plugin config set overlay /path/to/repo")
    fi

    if local_repo=$(get_local_repo); then
        log_ok "rhdh-local found: $local_repo"

        # Check compose file exists
        if [[ -f "$local_repo/compose.yaml" ]] || [[ -f "$local_repo/docker-compose.yaml" ]]; then
            log_ok "  Compose file found"
        else
            log_warn "  No compose file found"
        fi
    else
        log_fail "rhdh-local not found"
        issues+=("Configure rhdh-local: rhdh-plugin config set local /path/to/repo")
    fi

    header "GitHub CLI"

    if command -v gh &>/dev/null; then
        log_ok "gh CLI installed"

        if gh auth status &>/dev/null 2>&1; then
            log_ok "  Authenticated"

            # Check repo access
            if gh api repos/redhat-developer/rhdh-plugin-export-overlays --silent 2>/dev/null; then
                log_ok "  Can access overlay repo"
            else
                log_warn "  Cannot access overlay repo (may need permissions)"
            fi
        else
            log_fail "  Not authenticated"
            issues+=("Run: gh auth login")
        fi
    else
        log_fail "gh CLI not installed"
        issues+=("Install gh CLI: https://cli.github.com/")
    fi

    header "Container Runtime"

    if command -v podman &>/dev/null; then
        log_ok "podman installed"

        if podman ps &>/dev/null 2>&1; then
            log_ok "  Podman running"
        else
            log_warn "  Podman not running or not accessible"
        fi
    elif command -v docker &>/dev/null; then
        log_ok "docker installed"
    else
        log_fail "No container runtime found"
        issues+=("Install podman or docker for local testing")
    fi

    # Summary
    header "Summary"

    if [[ ${#issues[@]} -eq 0 ]]; then
        echo -e "  ${GREEN}All checks passed!${NC}"
        print_next_steps \
            "rhdh-plugin workspace list" "List plugin workspaces" \
            "/onboard-plugin" "Onboard a new plugin"
    else
        echo -e "  ${YELLOW}${#issues[@]} issue(s) found:${NC}"
        for issue in "${issues[@]}"; do
            echo "    - $issue"
        done
        print_next_steps \
            "rhdh-plugin config init" "Initialize configuration" \
            "rhdh-plugin config show" "Show current config"
    fi
}

# ============================================================================
# Config Commands
# ============================================================================

config_init() {
    header "Initializing Configuration"

    mkdir -p "$USER_CONFIG_DIR"

    if [[ -f "$USER_CONFIG_FILE" ]]; then
        log_warn "Config file already exists: $USER_CONFIG_FILE"
        print_next_steps \
            "rhdh-plugin config show" "View current config" \
            "rhdh-plugin config set <key> <path>" "Update a path"
        return 0
    fi

    # Try to auto-detect repos
    local overlay="" local_repo="" factory=""

    # Check skill root location
    if [[ -d "${SKILL_ROOT}/../repo/rhdh-plugin-export-overlays" ]]; then
        overlay="$(cd "${SKILL_ROOT}/../repo/rhdh-plugin-export-overlays" && pwd)"
    fi
    if [[ -d "${SKILL_ROOT}/../repo/rhdh-local" ]]; then
        local_repo="$(cd "${SKILL_ROOT}/../repo/rhdh-local" && pwd)"
    fi
    if [[ -d "${SKILL_ROOT}/../repo/rhdh-dynamic-plugin-factory" ]]; then
        factory="$(cd "${SKILL_ROOT}/../repo/rhdh-dynamic-plugin-factory" && pwd)"
    fi

    cat > "$USER_CONFIG_FILE" << EOF
{
  "repos": {
    "overlay": "${overlay}",
    "local": "${local_repo}",
    "factory": "${factory}"
  }
}
EOF

    log_ok "Created: $USER_CONFIG_FILE"

    if [[ -n "$overlay" ]]; then
        log_ok "Auto-detected overlay repo: $overlay"
    else
        log_info "overlay repo: not found (configure with: rhdh-plugin config set overlay /path)"
    fi

    if [[ -n "$local_repo" ]]; then
        log_ok "Auto-detected rhdh-local: $local_repo"
    else
        log_info "rhdh-local: not found (configure with: rhdh-plugin config set local /path)"
    fi

    print_next_steps \
        "rhdh-plugin config show" "View configuration" \
        "rhdh-plugin doctor" "Verify setup"
}

config_show() {
    header "Configuration"

    echo "  Config file: $USER_CONFIG_FILE"
    echo "  Skill root:  $SKILL_ROOT"
    echo ""

    if [[ -f "$USER_CONFIG_FILE" ]]; then
        echo "  User config:"
        jq '.' "$USER_CONFIG_FILE" 2>/dev/null | sed 's/^/    /'
    else
        echo "  User config: (not created)"
    fi

    header "Resolved Paths"

    local overlay local_repo factory

    if overlay=$(get_overlay_repo 2>/dev/null); then
        log_ok "overlay: $overlay"
    else
        log_fail "overlay: not found"
    fi

    if local_repo=$(get_local_repo 2>/dev/null); then
        log_ok "local: $local_repo"
    else
        log_fail "local: not found"
    fi

    if factory=$(get_factory_repo 2>/dev/null); then
        log_ok "factory: $factory"
    else
        log_info "factory: not configured"
    fi

    print_next_steps \
        "rhdh-plugin config set <key> <path>" "Update a path" \
        "rhdh-plugin doctor" "Verify setup"
}

config_set() {
    local key="$1"
    local value="$2"

    # Validate key
    case "$key" in
        overlay|local|factory) ;;
        *)
            echo "Error: Unknown config key: $key"
            echo "Valid keys: overlay, local, factory"
            return 1
            ;;
    esac

    # Validate path exists
    if [[ ! -d "$value" ]]; then
        echo "Error: Path does not exist: $value"
        return 1
    fi

    # Resolve to absolute path
    value="$(cd "$value" && pwd)"

    # Ensure config file exists
    mkdir -p "$USER_CONFIG_DIR"
    if [[ ! -f "$USER_CONFIG_FILE" ]]; then
        echo '{"repos":{}}' > "$USER_CONFIG_FILE"
    fi

    # Update config
    local tmp_file
    tmp_file=$(mktemp)
    jq ".repos.${key} = \"${value}\"" "$USER_CONFIG_FILE" > "$tmp_file"
    mv "$tmp_file" "$USER_CONFIG_FILE"

    log_ok "Set ${key} = ${value}"

    print_next_steps \
        "rhdh-plugin config show" "View configuration" \
        "rhdh-plugin doctor" "Verify setup"
}

# ============================================================================
# Workspace Commands
# ============================================================================

workspace_list() {
    local overlay_repo

    if ! overlay_repo=$(get_overlay_repo); then
        echo "Error: Overlay repo not found"
        print_next_steps \
            "rhdh-plugin config init" "Initialize configuration" \
            "rhdh-plugin doctor" "Diagnose issues"
        return 1
    fi

    header "Plugin Workspaces"
    echo "  Location: ${overlay_repo}/workspaces/"
    echo ""

    local count=0
    for workspace in "${overlay_repo}/workspaces/"*/; do
        if [[ -d "$workspace" ]]; then
            local name
            name=$(basename "$workspace")

            # Get info from source.json
            local repo_ref=""
            if [[ -f "${workspace}/source.json" ]]; then
                repo_ref=$(jq -r '."repo-ref" // "unknown"' "${workspace}/source.json" 2>/dev/null || echo "")
            fi

            printf "  ${BLUE}%-30s${NC} %s\n" "$name" "${repo_ref:-(no source.json)}"
            ((count++))
        fi
    done

    echo ""
    echo "  Total: $count workspaces"

    print_next_steps \
        "rhdh-plugin workspace status <name>" "Check specific workspace" \
        "/onboard-plugin" "Add new plugin"
}

workspace_status() {
    local name="$1"
    local overlay_repo

    if ! overlay_repo=$(get_overlay_repo); then
        echo "Error: Overlay repo not found"
        return 1
    fi

    local workspace="${overlay_repo}/workspaces/${name}"

    if [[ ! -d "$workspace" ]]; then
        echo "Error: Workspace not found: $name"
        print_next_steps \
            "rhdh-plugin workspace list" "List available workspaces"
        return 1
    fi

    header "Workspace: $name"

    # Show files
    echo "  Files:"
    for file in source.json plugins-list.yaml backstage.json; do
        if [[ -f "${workspace}/${file}" ]]; then
            log_ok "$file"
        else
            if [[ "$file" == "backstage.json" ]]; then
                log_info "$file (optional)"
            else
                log_fail "$file (required)"
            fi
        fi
    done

    # Show source.json details
    if [[ -f "${workspace}/source.json" ]]; then
        echo ""
        echo "  Source:"
        jq -r '
            "    repo: \(.repo)",
            "    ref:  \(."repo-ref")",
            "    backstage: \(."repo-backstage-version")"
        ' "${workspace}/source.json" 2>/dev/null || echo "    (invalid JSON)"
    fi

    # Show metadata
    if [[ -d "${workspace}/metadata" ]]; then
        echo ""
        echo "  Metadata files:"
        ls -1 "${workspace}/metadata/" 2>/dev/null | sed 's/^/    /'
    fi

    print_next_steps \
        "cd ${workspace}" "Navigate to workspace" \
        "rhdh-plugin workspace list" "List all workspaces"
}

# ============================================================================
# Help
# ============================================================================

show_help() {
    cat << 'EOF'
rhdh-plugin - CLI helper for RHDH plugin management

USAGE:
    rhdh-plugin [COMMAND] [OPTIONS]

COMMANDS:
    (no command)        Show environment status
    doctor              Full environment check

    config init         Initialize configuration file
    config show         Show current configuration
    config set <k> <v>  Set config value (overlay, local, factory)

    workspace list      List plugin workspaces
    workspace status    Show workspace details

ENVIRONMENT VARIABLES:
    RHDH_OVERLAY_REPO   Path to rhdh-plugin-export-overlays
    RHDH_LOCAL_REPO     Path to rhdh-local
    RHDH_FACTORY_REPO   Path to rhdh-dynamic-plugin-factory

LOCATION DISCOVERY:
    1. Environment variables (if set)
    2. User config (~/.config/rhdh-plugin-skill/config.json)
    3. Skill install root (../repo/ relative to skill)

EXAMPLES:
    rhdh-plugin                           # Show status
    rhdh-plugin doctor                    # Check setup
    rhdh-plugin config init               # Create config
    rhdh-plugin config set overlay /path  # Configure repo
    rhdh-plugin workspace list            # List workspaces
EOF
}

# ============================================================================
# Main
# ============================================================================

main() {
    local cmd="${1:-}"

    case "$cmd" in
        ""|status)
            show_status
            ;;
        doctor)
            run_doctor
            ;;
        config)
            local subcmd="${2:-}"
            case "$subcmd" in
                init)
                    config_init
                    ;;
                show)
                    config_show
                    ;;
                set)
                    if [[ $# -lt 4 ]]; then
                        echo "Usage: rhdh-plugin config set <key> <path>"
                        echo "Keys: overlay, local, factory"
                        return 1
                    fi
                    config_set "$3" "$4"
                    ;;
                *)
                    echo "Usage: rhdh-plugin config [init|show|set]"
                    return 1
                    ;;
            esac
            ;;
        workspace)
            local subcmd="${2:-}"
            case "$subcmd" in
                list)
                    workspace_list
                    ;;
                status)
                    if [[ -z "${3:-}" ]]; then
                        echo "Usage: rhdh-plugin workspace status <name>"
                        return 1
                    fi
                    workspace_status "$3"
                    ;;
                *)
                    echo "Usage: rhdh-plugin workspace [list|status <name>]"
                    return 1
                    ;;
            esac
            ;;
        -h|--help|help)
            show_help
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run 'rhdh-plugin --help' for usage"
            return 1
            ;;
    esac
}

main "$@"
